<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>觸控幾何鎖定版 - 數據聯動版</title>
  <script src="2025.js"></script>
  <style>
    body { margin:0; background:#000; color:#fff; font-family:sans-serif; display:flex; justify-content:center; align-items:center; height:100vh; overflow:hidden; touch-action: none; }
    .container { display:flex; background:#000; padding:10px; user-select: none; }
    canvas { background:#000; border:1px solid #333; cursor: crosshair; touch-action: none; }
    .panel { width:150px; background:#111; padding:15px; border-left:2px solid #f00; display:flex; flex-direction:column; gap:10px; }
    .group { background:#1a1a1a; border:1px solid #333; padding:10px; border-radius:10px; text-align:center; }
    button { width:100%; padding:10px; margin:5px 0; background:#333; color:#fff; border:1px solid #f00; border-radius:5px; cursor:pointer; font-size:20px; font-weight:bold; }
    button:active { background: #f00; color: #000; }
    .value { font-size:26px; color:#0f0; font-weight:bold; }
    .label { font-size:12px; color:#888; }
    #parser-ui { position: fixed; bottom: 0; left: 0; background: #222; padding: 10px; display: none; z-index: 100; }
  </style>

</head>
<body>

<div class="container">
  <canvas id="chart"></canvas>
  <div class="panel">
    <div class="group"><div class="label">天數 (6-60循環)</div><div id="val-days" class="value">6</div><button id="days-inc">▲</button><button id="days-dec">▼</button></div>
    <div class="group"><div class="label">紅閃 (日期)</div><div id="val-updown" class="value">0</div><button id="updown-inc">▲</button><button id="updown-dec">▼</button></div>
    <div class="group"><div class="label">綠閃 (號碼)</div><div id="val-leftright" class="value">1</div><button id="leftright-inc">▲</button><button id="leftright-dec">▼</button></div>
  </div>
</div>

<div id="parser-ui">
  <textarea id="input" rows="5" placeholder="貼上開獎網文字..."></textarea><br>
  <button onclick="run()">解析資料</button>
  <div id="info"></div>
  <pre id="output" style="font-size:10px; color:#aaa; max-height:100px; overflow:auto;"></pre>
</div>

<script>
const c = document.getElementById('chart');
const ctx = c.getContext('2d');
let n_multiplier = 1; 
let blinkRow = 0, blinkCol = 0, blink = true;

// --- 數據對接中心 ---
let allDates = [];
let allNums = [];
let yearFreq = Array(39).fill(0);

function prepareData() {
  // 核心修正：確保變數名完全對應 ywn2025
  const sourceData = (typeof ywn2025 !== 'undefined') ? ywn2025 : [];
  
  if (sourceData.length > 0) {
    // 1. 提取日期：將 "2025/12/31" 轉為 "12/31"
    allDates = sourceData.map(d => {
        if(!d[0]) return "";
        const parts = d[0].split('/');
        return (parts[1] || "") + "/" + (parts[2] || "") + (d[1] || "");
    });

    // 2. 提取號碼：將字串轉換為整數供繪圖使用
    allNums = sourceData.map(d => d[2] ? d[2].map(n => parseInt(n)) : []);

    // 3. 自動計算 [01-39次數]：根據所有數據自動生成長條圖高度
    yearFreq.fill(0);
    allNums.forEach(draw => {
      draw.forEach(num => {
        if(num >= 1 && num <= 39) yearFreq[num-1]++;
      });
    });
    console.log("數據載入成功，總筆數：", sourceData.length);
  } else {
    console.error("錯誤：找不到 ywn2025 變數，請檢查 2025.js 是否正確載入。");
  }
}

function draw() {
  const showDays = n_multiplier * 6;
  const baseH = 500, baseW = 800;
  const X = baseH / 6; 
  
  c.height = baseH + X + 100; 
  c.width = baseW + (10 * X / 6) + 120; 

  const pad = {l:90, r:40, t:30, b:85}; 
  const w = c.width - pad.l - pad.r;
  const h = c.height - pad.t - pad.b;
  const cw = w / 39;
  const rh = h / (showDays - 1); 

  ctx.fillStyle = '#000'; ctx.fillRect(0,0,c.width,c.height);

  // 1. 繪製背景參考線與次數條
  for(let i=0; i<39; i++) {
    const x = pad.l + i*cw;
    let val = yearFreq[i];
    
    // 藍色長條圖 (次數統計)
    if(val > 0) {
      let barH = ((val)/(Math.max(...yearFreq) || 60)) * h; 
      ctx.save();
      const isPick = (i === blinkCol);
      ctx.fillStyle = isPick && blink ? '#0ff' : 'rgba(0, 200, 255, 0.2)';
      ctx.fillRect(x+1, pad.t + h - barH, cw-2, barH);
      
      // 顯示次數文字
      ctx.fillStyle = isPick && blink ? '#fff' : '#0ff';
      ctx.font = 'bold 11px Arial'; ctx.textAlign='center';
      ctx.fillText(val, x+cw/2, pad.t + h - barH - 5);
      ctx.restore();
    }

    // 底部 01-39 標籤
    ctx.fillStyle = (i === blinkCol) ? '#0f0' : '#888';
    ctx.font = 'bold 12px Arial'; ctx.textAlign='center';
    ctx.fillText((i+1).toString().padStart(2,'0'), x+cw/2, pad.t+h+30);
  }

  // 2. 繪製每一天的數據
  for(let r=0; r<showDays; r++) {
    const y = pad.t + r * rh; 
    
    // 日期顯示
    ctx.fillStyle = (r === blinkRow && blink) ? '#f00' : '#666';
    let fontSize = Math.max(9, Math.min(13, rh * 0.45));
    ctx.font = `bold ${fontSize}px Arial`; ctx.textAlign = 'left';
    ctx.fillText(allDates[r] || "", 5, y + fontSize/3);

    // 號碼紅點 (抓取 allNums[r])
    if(allNums[r]) {
      allNums[r].forEach(n => {
        const x = pad.l + (n-1)*cw + cw/2;
        const onRed = (r === blinkRow), onGreen = (n-1 === blinkCol);
        
        ctx.save();
        let dotR = Math.min(cw/2.2, rh/2.2);
        ctx.fillStyle = (onRed && onGreen && blink) ? '#fff' : ((onRed || onGreen) && blink ? '#f00' : '#400');
        ctx.beginPath(); ctx.arc(x, y, dotR, 0, Math.PI*2); ctx.fill();
        
        // 點內數字
        if (rh > 10) {
            ctx.fillStyle = (onRed && onGreen && blink) ? '#000' : '#fff';
            ctx.font = `bold ${dotR*1.2}px Arial`; ctx.textAlign='center'; ctx.textBaseline='middle';
            ctx.fillText(n.toString().padStart(2,'0'), x, y);
        }
        ctx.restore();
      });
    }
  }

  // 3. 十字交叉閃爍線
  if(blink) {
    const targetY = pad.t + blinkRow * rh; 
    ctx.strokeStyle = 'rgba(255,0,0,0.5)'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad.l, targetY); ctx.lineTo(pad.l+w, targetY); ctx.stroke();
    
    const targetX = pad.l + blinkCol * cw + cw/2;
    ctx.strokeStyle = 'rgba(0,255,0,0.5)'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(targetX, pad.t); ctx.lineTo(targetX, pad.t+h); ctx.stroke();
  }
}

// --- 控制與同步邏輯 ---
function sync(){ 
  document.getElementById('val-days').textContent = n_multiplier * 6; 
  document.getElementById('val-updown').textContent = blinkRow; 
  document.getElementById('val-leftright').textContent = (blinkCol + 1).toString().padStart(2,'0'); 
  draw(); 
}

function handleInteraction(e) {
  const rect = c.getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  const x = (clientX - rect.left) * (c.width / rect.width);
  const y = (clientY - rect.top) * (c.height / rect.height);
  const pad = {l:90, r:40, t:30, b:85};
  const cw = (c.width - pad.l - pad.r) / 39;
  const rh = (c.height - pad.t - pad.b) / (n_multiplier * 6 - 1);

  let col = Math.floor((x - pad.l) / cw);
  let row = Math.round((y - pad.t) / rh);
  if (col >= 0 && col < 39) blinkCol = col;
  if (row >= 0 && row < (n_multiplier * 6)) blinkRow = row;
  sync();
}

// 事件綁定
c.addEventListener('mousedown', (e) => { handleInteraction(e); c.isDrawing = true; });
c.addEventListener('mousemove', (e) => { if(c.isDrawing) handleInteraction(e); });
window.addEventListener('mouseup', () => { c.isDrawing = false; });
c.addEventListener('touchstart', (e) => { e.preventDefault(); handleInteraction(e); }, {passive: false});
c.addEventListener('touchmove', (e) => { e.preventDefault(); handleInteraction(e); }, {passive: false});

document.getElementById('days-inc').onclick=()=>{ n_multiplier++; if(n_multiplier > 10) n_multiplier = 1; sync(); };
document.getElementById('days-dec').onclick=()=>{ n_multiplier--; if(n_multiplier < 1) n_multiplier = 10; sync(); };
document.getElementById('updown-inc').onclick=()=>{ blinkRow=(blinkRow+1)%(n_multiplier*6); sync(); };
document.getElementById('updown-dec').onclick=()=>{ blinkRow=(blinkRow-1+(n_multiplier*6))%(n_multiplier*6); sync(); };
document.getElementById('leftright-inc').onclick=()=>{ blinkCol=(blinkCol+1)%39; sync(); };
document.getElementById('leftright-dec').onclick=()=>{ blinkCol=(blinkCol-1+39)%39; sync(); };

// 初始化
prepareData();
sync();
setInterval(()=>{ blink=!blink; draw(); }, 400);

// 解析器工具邏輯 (按 P)
window.addEventListener('keydown', (e) => { if(e.key.toLowerCase() === 'p') { const ui = document.getElementById('parser-ui'); ui.style.display = ui.style.display === 'block' ? 'none' : 'block'; } });

function run() {
  const txt = document.getElementById('input').value;
  const dates = txt.match(/2025\/\d{2}\/\d{2}/g);
  const segs = txt.split(/2025\/\d{2}\/\d{2}/);
  let res = [];
  if (dates) {
    dates.forEach((d, i) => {
      const n = (segs[i+1] || "").match(/\d{2}/g);
      if (n && n.length >= 5) {
        const w = ["(日)","(一)","(二)","(三)","(四)","(五)","(六)"][new Date(d).getDay()];
        res.push(`["${d}","${w}",["${n.slice(0,5).join('","')}"]]`);
      }
    });
    document.getElementById('output').innerText = res.join(",\n") + ",";
  }
}
</script>
</body>
</html>
